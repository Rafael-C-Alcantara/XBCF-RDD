data <- readstata13::read.dta13("~/Documents/Git/XBCF-RDD/Application/konda_data_for_analysis.dta")
data <- data[complete.cases(data),]
wmean <- function(x,var)
{
    c <- cov(x)
    c <- solve(c)
    w <- rowSums(c)
    w <- w/sum(w)
    x <- apply(x,2,function(i) (i-mean(i))/sd(i[var]))
    x <- x%*%w
    return(x)
}
depression <- subset(data,
                     select=c("head_ache","mal_appetite",
                              "sleeplessness","scared",
                              "shaking","nervous",
                              "indigestion","unfocused",
                              "unhappy","weepy",
                              "unwillingness","undecisiveness",
                              "disrupted","useless",
                              "uninterest","worthless",
                              "suicidal","usually_tired",
                              "stomach_discomfort","quickly_tired"))
somatic <- subset(data,
                  select=c("head_ache","shaking",
                           "indigestion","stomach_discomfort"))
nonsomatic <- subset(data,
                     select=c("mal_appetite","sleeplessness",
                              "scared","nervous","unfocused",
                              "unhappy","weepy","unwillingness",
                              "undecisiveness","disrupted",
                              "useless","uninterest",
                              "worthless","suicidal",
                              "usually_tired","quickly_tired"))
religion <- subset(data,
                   select=c("religious","daily_pray",
                            "practice_the_book","virus_god_sent"))
depression <- wmean(depression,data$before1955==0)
somatic <- wmean(somatic,data$before1955==0)
nonsomatic <- wmean(nonsomatic,data$before1955==0)
religion <- wmean(religion,data$before1955==0)
w <- subset(data, select=c("ethnicity","education",
                           "female","survey_taker_id"))
x <- data$dif
###
rdrobust::rdplot(depression,x,0,masspoints="off")
summary(rdrobust::rdrobust(depression,x,0,h=17,masspoints="off"))
